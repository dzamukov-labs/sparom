<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç—Ä–æ–π–ì–ª–æ–±–∞–ª | –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-right: 1px solid var(--border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 32px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 32px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--shadow-glow);
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 4px;
            color: var(--text-secondary);
            text-decoration: none;
        }

        .nav-item:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .nav-item-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .nav-item-text {
            font-weight: 500;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 10px;
            font-size: 13px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .main {
            margin-left: 280px;
            padding: 32px;
            min-height: 100vh;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stat-card.gradient-1::before { background: var(--gradient-1); }
        .stat-card.gradient-2::before { background: var(--gradient-2); }
        .stat-card.gradient-3::before { background: var(--gradient-3); }
        .stat-card.gradient-4::before { background: var(--gradient-4); }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .stat-card.gradient-1 .stat-icon { background: rgba(102, 126, 234, 0.2); }
        .stat-card.gradient-2 .stat-icon { background: rgba(245, 87, 108, 0.2); }
        .stat-card.gradient-3 .stat-icon { background: rgba(79, 172, 254, 0.2); }
        .stat-card.gradient-4 .stat-icon { background: rgba(67, 233, 123, 0.2); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-body {
            padding: 24px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            filter: brightness(1.1);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-dark);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            color: var(--primary-light);
        }

        th.sortable::after {
            content: ' ‚Üï';
            opacity: 0.3;
        }

        th.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        th.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        tr:hover {
            background: var(--bg-card-hover);
        }

        td {
            font-size: 14px;
        }

        /* UTM Tags */
        .utm-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px;
        }

        .utm-source { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
        .utm-medium { background: rgba(245, 87, 108, 0.2); color: #fda4af; }
        .utm-campaign { background: rgba(79, 172, 254, 0.2); color: #7dd3fc; }
        .utm-content { background: rgba(67, 233, 123, 0.2); color: #86efac; }
        .utm-term { background: rgba(251, 191, 36, 0.2); color: #fcd34d; }
        .utm-empty { background: var(--bg-dark); color: var(--text-muted); }

        /* Filters */
        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="text"], input[type="number"] {
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            min-width: 180px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* Sync Panel */
        .sync-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .sync-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
        }

        .sync-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .sync-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .sync-card.yandex .sync-card-icon {
            background: rgba(255, 204, 0, 0.2);
        }

        .sync-card.amo .sync-card-icon {
            background: rgba(79, 172, 254, 0.2);
        }

        .sync-card.full .sync-card-icon {
            background: rgba(67, 233, 123, 0.2);
        }

        .sync-card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .sync-card-desc {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .sync-options {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .sync-options select {
            flex: 1;
        }

        /* Analytics Table */
        .analytics-table th:not(:first-child):not(:nth-child(2)),
        .analytics-table td:not(:first-child):not(:nth-child(2)) {
            text-align: center;
        }

        .cell-cost {
            color: var(--warning);
            font-weight: 500;
        }

        .cell-leads {
            color: var(--success);
            font-weight: 600;
        }

        .cell-cpl {
            color: var(--primary-light);
            font-size: 12px;
        }

        .cell-empty {
            color: var(--text-muted);
        }

        /* Logs */
        .log-entry {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: var(--bg-dark);
        }

        .log-entry.success { border-left: 3px solid var(--success); }
        .log-entry.error { border-left: 3px solid var(--danger); }
        .log-entry.started { border-left: 3px solid var(--warning); }

        .log-time {
            font-size: 12px;
            color: var(--text-muted);
            min-width: 150px;
        }

        .log-type {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--bg-card-hover);
            min-width: 100px;
            text-align: center;
        }

        .log-message {
            flex: 1;
            font-size: 13px;
        }

        /* Broadcasts Section */
        .chat-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border);
        }

        .chat-item:hover {
            background: var(--bg-card-hover);
        }

        .chat-item.selected {
            background: var(--primary);
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            object-fit: cover;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Broadcast Form */
        .broadcast-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
            font-size: 14px;
        }

        textarea {
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 18px;
            margin-bottom: 8px;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alerts */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .alert-info {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid var(--primary);
            color: var(--primary-light);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
                padding: 16px;
            }

            .logo-text, .logo-subtitle, .nav-item-text, .nav-section-title {
                display: none;
            }

            .logo-icon {
                width: 40px;
                height: 40px;
            }

            .nav-item {
                justify-content: center;
                padding: 14px;
            }

            .main {
                margin-left: 80px;
            }

            .sync-status span {
                display: none;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">üèóÔ∏è</div>
            <div>
                <div class="logo-text">–°—Ç—Ä–æ–π–ì–ª–æ–±–∞–ª</div>
                <div class="logo-subtitle">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
            </div>
        </div>

        <nav>
            <div class="nav-section">
                <div class="nav-section-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
                <a class="nav-item active" data-section="analytics">
                    <span class="nav-item-icon">üìä</span>
                    <span class="nav-item-text">–°–≤–æ–¥–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</span>
                </a>
                <a class="nav-item" data-section="leads">
                    <span class="nav-item-icon">üë•</span>
                    <span class="nav-item-text">–°–¥–µ–ª–∫–∏ CRM</span>
                </a>
                <a class="nav-item" data-section="sync">
                    <span class="nav-item-icon">üîÑ</span>
                    <span class="nav-item-text">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</div>
                <a class="nav-item" data-section="broadcasts">
                    <span class="nav-item-icon">üì®</span>
                    <span class="nav-item-text">–†–∞—Å—Å—ã–ª–∫–∏</span>
                </a>
                <a class="nav-item" data-section="chats">
                    <span class="nav-item-icon">üí¨</span>
                    <span class="nav-item-text">–ß–∞—Ç—ã</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">–°–∏—Å—Ç–µ–º–∞</div>
                <a class="nav-item" data-section="logs">
                    <span class="nav-item-icon">üìã</span>
                    <span class="nav-item-text">–õ–æ–≥–∏</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="sync-status">
                <div class="sync-dot"></div>
                <span>–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <!-- Analytics Section -->
        <section id="analytics" class="section active">
            <div class="page-header">
                <h1 class="page-title">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–µ–∫–ª–∞–º—ã</h1>
                <p class="page-subtitle">–†–∞—Å—Ö–æ–¥—ã –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç –∏ –∑–∞–∫–∞–∑—ã –∏–∑ AmoCRM</p>
            </div>

            <div class="stats-grid" id="stats-cards">
                <div class="stat-card gradient-1">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value" id="stat-total-cost">‚Äî</div>
                    <div class="stat-label">–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥</div>
                </div>
                <div class="stat-card gradient-2">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-value" id="stat-total-leads">‚Äî</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                </div>
                <div class="stat-card gradient-3">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="stat-avg-cpl">‚Äî</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞–∫–∞–∑–∞</div>
                </div>
                <div class="stat-card gradient-4">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-value" id="stat-months">‚Äî</div>
                    <div class="stat-label">–ú–µ—Å—è—Ü–µ–≤ –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìã –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º –∏ –º–µ—Å—è—Ü–∞–º</h3>
                    <button class="btn btn-sm btn-secondary" onclick="exportAnalytics()">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
                </div>
                <div class="card-body">
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">–ì–æ–¥</label>
                            <select id="filter-year" onchange="loadAnalytics()">
                                <option value="">–í—Å–µ –≥–æ–¥—ã</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container" id="analytics-table">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Leads Section -->
        <section id="leads" class="section">
            <div class="page-header">
                <h1 class="page-title">üë• –°–¥–µ–ª–∫–∏ –∏–∑ AmoCRM</h1>
                <p class="page-subtitle">–í—Å–µ —Å–¥–µ–ª–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–∑–∞—è–≤–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞" ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ –ø–æ UTM-–º–µ—Ç–∫–∞–º</p>
            </div>

            <div class="alert alert-info">
                <span>üí°</span>
                <span>–í –∞–Ω–∞–ª–∏—Ç–∏–∫—É –Ø–Ω–¥–µ–∫—Å –ø–æ–ø–∞–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ –∑–∞–∫–∞–∑—ã –≥–¥–µ <strong>utm_source —Å–æ–¥–µ—Ä–∂–∏—Ç "yandex"</strong> –∏ –µ—Å—Ç—å <strong>ID –∫–∞–º–ø–∞–Ω–∏–∏</strong> –≤ utm_campaign</span>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üîç –§–∏–ª—å—Ç—Ä—ã</h3>
                    <button class="btn btn-sm btn-primary" onclick="loadLeads()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div class="card-body">
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">UTM Source</label>
                            <select id="filter-utm-source" onchange="filterLeads()">
                                <option value="">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">UTM Medium</label>
                            <select id="filter-utm-medium" onchange="filterLeads()">
                                <option value="">–í—Å–µ medium</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">UTM Campaign</label>
                            <select id="filter-utm-campaign" onchange="filterLeads()">
                                <option value="">–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">–°—Ç–∞—Ç—É—Å</label>
                            <select id="filter-status" onchange="filterLeads()">
                                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">–¢–æ–ª—å–∫–æ –¥–ª—è –Ø–Ω–¥–µ–∫—Å</label>
                            <select id="filter-yandex-only" onchange="filterLeads()">
                                <option value="">–í—Å–µ —Å–¥–µ–ª–∫–∏</option>
                                <option value="yes">‚úÖ –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ –Ø–Ω–¥–µ–∫—Å</option>
                                <option value="no">‚ùå –ù–ï —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìã –°–ø–∏—Å–æ–∫ —Å–¥–µ–ª–æ–∫ <span id="leads-count" class="badge badge-success">0</span></h3>
                </div>
                <div class="card-body">
                    <div class="table-container" id="leads-table">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sync Section -->
        <section id="sync" class="section">
            <div class="page-header">
                <h1 class="page-title">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h1>
                <p class="page-subtitle">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç –∏ AmoCRM</p>
            </div>

            <div class="sync-panel">
                <div class="sync-card yandex">
                    <div class="sync-card-header">
                        <div class="sync-card-icon">üü°</div>
                        <div>
                            <div class="sync-card-title">–Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç</div>
                        </div>
                    </div>
                    <div class="sync-card-desc">
                        <strong>–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:</strong> –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥—ã –ø–æ —Ä–µ–∫–ª–∞–º–Ω—ã–º –∫–∞–º–ø–∞–Ω–∏—è–º –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü.<br><br>
                        <strong>–û—Ç–∫—É–¥–∞:</strong> API –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç Reports<br>
                        <strong>–ö—É–¥–∞:</strong> –¢–∞–±–ª–∏—Ü–∞ yandex_expenses –≤ Supabase
                    </div>
                    <div class="sync-options">
                        <select id="yandex-year">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                        </select>
                        <select id="yandex-month">
                            <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
                            <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
                            <option value="3">–ú–∞—Ä—Ç</option>
                            <option value="4">–ê–ø—Ä–µ–ª—å</option>
                            <option value="5">–ú–∞–π</option>
                            <option value="6">–ò—é–Ω—å</option>
                            <option value="7">–ò—é–ª—å</option>
                            <option value="8">–ê–≤–≥—É—Å—Ç</option>
                            <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
                            <option value="10">–û–∫—Ç—è–±—Ä—å</option>
                            <option value="11">–ù–æ—è–±—Ä—å</option>
                            <option value="12">–î–µ–∫–∞–±—Ä—å</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="syncYandex()">üü° –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ø–Ω–¥–µ–∫—Å</button>
                </div>

                <div class="sync-card amo">
                    <div class="sync-card-header">
                        <div class="sync-card-icon">üîµ</div>
                        <div>
                            <div class="sync-card-title">AmoCRM</div>
                        </div>
                    </div>
                    <div class="sync-card-desc">
                        <strong>–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:</strong> –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–¥–µ–ª–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–∑–∞—è–≤–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞" (–∑–∞–∫–∞–∑—ã), —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—è—Ü–µ.<br><br>
                        <strong>–û—Ç–∫—É–¥–∞:</strong> API AmoCRM v4<br>
                        <strong>–ö—É–¥–∞:</strong> –¢–∞–±–ª–∏—Ü–∞ crm_leads –≤ Supabase
                    </div>
                    <div class="sync-options">
                        <select id="amo-year">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                        </select>
                        <select id="amo-month">
                            <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
                            <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
                            <option value="3">–ú–∞—Ä—Ç</option>
                            <option value="4">–ê–ø—Ä–µ–ª—å</option>
                            <option value="5">–ú–∞–π</option>
                            <option value="6">–ò—é–Ω—å</option>
                            <option value="7">–ò—é–ª—å</option>
                            <option value="8">–ê–≤–≥—É—Å—Ç</option>
                            <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
                            <option value="10">–û–∫—Ç—è–±—Ä—å</option>
                            <option value="11">–ù–æ—è–±—Ä—å</option>
                            <option value="12">–î–µ–∫–∞–±—Ä—å</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="syncAmo()">üîµ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å AmoCRM</button>
                </div>

                <div class="sync-card full">
                    <div class="sync-card-header">
                        <div class="sync-card-icon">üü¢</div>
                        <div>
                            <div class="sync-card-title">–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</div>
                        </div>
                    </div>
                    <div class="sync-card-desc">
                        <strong>–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:</strong> –ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥:<br>
                        1. –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Ö–æ–¥—ã –∏–∑ –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç<br>
                        2. –ó–∞—Ç–µ–º –∑–∞–∫–∞–∑—ã –∏–∑ AmoCRM<br><br>
                        <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
                    </div>
                    <div class="sync-options">
                        <select id="full-year-from">
                            <option value="2024">–° 2024</option>
                            <option value="2025">–° 2025</option>
                        </select>
                        <select id="full-month-from">
                            <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
                            <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
                            <option value="3">–ú–∞—Ä—Ç</option>
                            <option value="4">–ê–ø—Ä–µ–ª—å</option>
                            <option value="5">–ú–∞–π</option>
                            <option value="6">–ò—é–Ω—å</option>
                            <option value="7">–ò—é–ª—å</option>
                            <option value="8">–ê–≤–≥—É—Å—Ç</option>
                            <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
                            <option value="10">–û–∫—Ç—è–±—Ä—å</option>
                            <option value="11">–ù–æ—è–±—Ä—å</option>
                            <option value="12">–î–µ–∫–∞–±—Ä—å</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="syncFull()">üü¢ –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
                </div>
            </div>

            <div class="card" style="margin-top: 24px;">
                <div class="card-header">
                    <h3 class="card-title">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</h3>
                </div>
                <div class="card-body">
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="testYandex()">üü° –¢–µ—Å—Ç –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç</button>
                        <button class="btn btn-secondary" onclick="testAmo()">üîµ –¢–µ—Å—Ç AmoCRM</button>
                    </div>
                    <div id="test-result" style="margin-top: 16px;"></div>
                </div>
            </div>
        </section>

        <!-- Broadcasts Section -->
        <section id="broadcasts" class="section">
            <div class="page-header">
                <h1 class="page-title">üì® –†–∞—Å—Å—ã–ª–∫–∏</h1>
                <p class="page-subtitle">–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞–º —á–µ—Ä–µ–∑ Telegram</p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üë• –ü–æ–ª—É—á–∞—Ç–µ–ª–∏</h3>
                        <button class="btn btn-sm btn-secondary" onclick="loadChats()">üîÑ</button>
                    </div>
                    <div class="card-body" style="padding: 0; max-height: 500px; overflow-y: auto;">
                        <div id="broadcast-recipients" class="chat-list">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ</h3>
                    </div>
                    <div class="card-body">
                        <div class="broadcast-form">
                            <div class="form-group">
                                <label class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                                <textarea id="broadcast-message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">–í—ã–±—Ä–∞–Ω–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: <span id="selected-count">0</span></label>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="sendBroadcast()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
                                <button class="btn btn-secondary" onclick="selectAllChats()">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö</button>
                                <button class="btn btn-secondary" onclick="deselectAllChats()">–°–Ω—è—Ç—å –≤—ã–±–æ—Ä</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Chats Section -->
        <section id="chats" class="section">
            <div class="page-header">
                <h1 class="page-title">üí¨ –ß–∞—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h1>
                <p class="page-subtitle">–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∏–∑ Telegram –±–æ—Ç–∞</p>
            </div>

            <div style="display: grid; grid-template-columns: 350px 1fr; gap: 24px;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">–î–∏–∞–ª–æ–≥–∏</h3>
                        <button class="btn btn-sm btn-secondary" onclick="loadChatsForView()">üîÑ</button>
                    </div>
                    <div class="card-body" style="padding: 0; max-height: 600px; overflow-y: auto;">
                        <div id="chats-list" class="chat-list">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" id="chat-header">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                    </div>
                    <div class="card-body" id="chat-messages" style="max-height: 500px; overflow-y: auto;">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <div class="empty-state-text">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å–ª–µ–≤–∞</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Logs Section -->
        <section id="logs" class="section">
            <div class="page-header">
                <h1 class="page-title">üìã –õ–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h1>
                <p class="page-subtitle">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
                    <button class="btn btn-sm btn-secondary" onclick="loadLogs()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div class="card-body" id="logs-container">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Config
        const API_BASE = '';
        const AUTH_KEY = localStorage.getItem('yandex_admin_key') || prompt('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞:');
        if (AUTH_KEY) localStorage.setItem('yandex_admin_key', AUTH_KEY);

        // State
        let allLeads = [];
        let selectedChats = new Set();

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                if (!section) return;

                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

                item.classList.add('active');
                document.getElementById(section).classList.add('active');

                // Load data for section
                if (section === 'analytics') loadAnalytics();
                if (section === 'leads') loadLeads();
                if (section === 'logs') loadLogs();
                if (section === 'broadcasts') loadChats();
                if (section === 'chats') loadChatsForView();
            });
        });

        // API Helper
        async function api(endpoint, options = {}) {
            const url = API_BASE + endpoint;
            const headers = {
                'Content-Type': 'application/json',
                'X-Yandex-Key': AUTH_KEY
            };

            try {
                const response = await fetch(url, { ...options, headers });
                return await response.json();
            } catch (err) {
                console.error('API Error:', err);
                return { success: false, error: err.message };
            }
        }

        // Format helpers
        function formatMoney(value) {
            if (!value && value !== 0) return '‚Äî';
            return new Intl.NumberFormat('ru-RU').format(Math.round(value)) + ' ‚ÇΩ';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '‚Äî';
            return new Date(dateStr).toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Analytics
        async function loadAnalytics() {
            const year = document.getElementById('filter-year').value;
            const params = new URLSearchParams();
            if (year) params.append('year', year);

            const data = await api('/api/analytics?' + params.toString());

            if (data.success) {
                renderAnalytics(data);
            } else {
                document.getElementById('analytics-table').innerHTML =
                    `<div class="alert alert-error">–û—à–∏–±–∫–∞: ${data.error}</div>`;
            }
        }

        function renderAnalytics(data) {
            const { campaigns, months, summary } = data;

            // Stats
            document.getElementById('stat-total-cost').textContent = formatMoney(summary.total_cost);
            document.getElementById('stat-total-leads').textContent = summary.total_leads || 0;
            document.getElementById('stat-avg-cpl').textContent = formatMoney(summary.avg_cpl);
            document.getElementById('stat-months').textContent = months?.length || 0;

            if (!campaigns || campaigns.length === 0) {
                document.getElementById('analytics-table').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">üìä</div><div class="empty-state-text">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div><div>–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤ —Ä–∞–∑–¥–µ–ª–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è"</div></div>';
                return;
            }

            // Table
            let html = '<table class="analytics-table"><thead><tr><th>ID –∫–∞–º–ø–∞–Ω–∏–∏</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>';
            months.forEach(m => {
                html += `<th>${m}</th>`;
            });
            html += '<th>–ò—Ç–æ–≥–æ</th></tr></thead><tbody>';

            campaigns.forEach(campaign => {
                let totalCost = 0, totalLeads = 0;

                html += `<tr><td><code>${campaign.campaign_id}</code></td><td>${campaign.campaign_name || '‚Äî'}</td>`;

                months.forEach(m => {
                    const monthData = campaign.months[m];
                    if (monthData) {
                        totalCost += monthData.cost || 0;
                        totalLeads += monthData.leads || 0;

                        html += '<td>';
                        html += `<div class="cell-cost">${formatMoney(monthData.cost)}</div>`;
                        html += `<div class="cell-leads">${monthData.leads || 0} –∑–∞–∫–∞–∑–æ–≤</div>`;
                        if (monthData.cost_per_lead) {
                            html += `<div class="cell-cpl">${formatMoney(monthData.cost_per_lead)}/–∑–∞–∫–∞–∑</div>`;
                        }
                        html += '</td>';
                    } else {
                        html += '<td class="cell-empty">‚Äî</td>';
                    }
                });

                const avgCpl = totalLeads > 0 ? Math.round(totalCost / totalLeads) : null;
                html += '<td>';
                html += `<div class="cell-cost">${formatMoney(totalCost)}</div>`;
                html += `<div class="cell-leads">${totalLeads} –∑–∞–∫–∞–∑–æ–≤</div>`;
                if (avgCpl) html += `<div class="cell-cpl">${formatMoney(avgCpl)}/–∑–∞–∫–∞–∑</div>`;
                html += '</td></tr>';
            });

            html += '</tbody></table>';
            document.getElementById('analytics-table').innerHTML = html;
        }

        // Leads
        async function loadLeads() {
            document.getElementById('leads-table').innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            const data = await api('/api/crm-leads/all');

            if (data.success) {
                allLeads = data.leads || [];
                populateFilters();
                filterLeads();
            } else {
                document.getElementById('leads-table').innerHTML =
                    `<div class="alert alert-error">–û—à–∏–±–∫–∞: ${data.error}</div>`;
            }
        }

        function populateFilters() {
            const sources = new Set();
            const mediums = new Set();
            const campaigns = new Set();
            const statuses = new Set();

            allLeads.forEach(lead => {
                if (lead.utm_source) sources.add(lead.utm_source);
                if (lead.utm_medium) mediums.add(lead.utm_medium);
                if (lead.utm_campaign) campaigns.add(lead.utm_campaign);
                if (lead.status_name) statuses.add(lead.status_name);
            });

            fillSelect('filter-utm-source', sources, '–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏');
            fillSelect('filter-utm-medium', mediums, '–í—Å–µ medium');
            fillSelect('filter-utm-campaign', campaigns, '–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏');
            fillSelect('filter-status', statuses, '–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã');
        }

        function fillSelect(id, values, defaultText) {
            const select = document.getElementById(id);
            const currentValue = select.value;
            select.innerHTML = `<option value="">${defaultText}</option>`;
            Array.from(values).sort().forEach(v => {
                select.innerHTML += `<option value="${v}">${v}</option>`;
            });
            select.value = currentValue;
        }

        function filterLeads() {
            const sourceFilter = document.getElementById('filter-utm-source').value.toLowerCase();
            const mediumFilter = document.getElementById('filter-utm-medium').value.toLowerCase();
            const campaignFilter = document.getElementById('filter-utm-campaign').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value.toLowerCase();
            const yandexOnly = document.getElementById('filter-yandex-only').value;

            let filtered = allLeads.filter(lead => {
                if (sourceFilter && (lead.utm_source || '').toLowerCase() !== sourceFilter) return false;
                if (mediumFilter && (lead.utm_medium || '').toLowerCase() !== mediumFilter) return false;
                if (campaignFilter && (lead.utm_campaign || '').toLowerCase() !== campaignFilter) return false;
                if (statusFilter && (lead.status_name || '').toLowerCase() !== statusFilter) return false;

                if (yandexOnly === 'yes') {
                    // –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –Ø–Ω–¥–µ–∫—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–µ
                    const isYandex = (lead.utm_source || '').toLowerCase() === 'yandex';
                    const hasCampaignId = lead.extracted_campaign_id != null;
                    if (!isYandex || !hasCampaignId) return false;
                } else if (yandexOnly === 'no') {
                    const isYandex = (lead.utm_source || '').toLowerCase() === 'yandex';
                    const hasCampaignId = lead.extracted_campaign_id != null;
                    if (isYandex && hasCampaignId) return false;
                }

                return true;
            });

            document.getElementById('leads-count').textContent = filtered.length;
            renderLeadsTable(filtered);
        }

        function renderLeadsTable(leads) {
            if (leads.length === 0) {
                document.getElementById('leads-table').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">üë•</div><div class="empty-state-text">–ù–µ—Ç —Å–¥–µ–ª–æ–∫</div></div>';
                return;
            }

            let html = `<table>
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortLeads('lead_id')">ID</th>
                        <th class="sortable" onclick="sortLeads('lead_name')">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th class="sortable" onclick="sortLeads('lead_created_at')">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th>UTM Source</th>
                        <th>UTM Medium</th>
                        <th>UTM Campaign</th>
                        <th>ID –∫–∞–º–ø–∞–Ω–∏–∏</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–í –Ø–Ω–¥–µ–∫—Å?</th>
                    </tr>
                </thead>
                <tbody>`;

            leads.forEach(lead => {
                const isYandex = (lead.utm_source || '').toLowerCase() === 'yandex';
                const hasCampaignId = lead.extracted_campaign_id != null;
                const inYandexAnalytics = isYandex && hasCampaignId;

                html += `<tr>
                    <td><code>${lead.lead_id}</code></td>
                    <td>${lead.lead_name || '‚Äî'}</td>
                    <td>${formatDate(lead.lead_created_at)}</td>
                    <td>${lead.utm_source ? `<span class="utm-tag utm-source">${lead.utm_source}</span>` : '<span class="utm-tag utm-empty">‚Äî</span>'}</td>
                    <td>${lead.utm_medium ? `<span class="utm-tag utm-medium">${lead.utm_medium}</span>` : '<span class="utm-tag utm-empty">‚Äî</span>'}</td>
                    <td>${lead.utm_campaign ? `<span class="utm-tag utm-campaign">${lead.utm_campaign}</span>` : '<span class="utm-tag utm-empty">‚Äî</span>'}</td>
                    <td>${lead.extracted_campaign_id ? `<code>${lead.extracted_campaign_id}</code>` : '<span class="utm-tag utm-empty">‚Äî</span>'}</td>
                    <td>${lead.status_name || '‚Äî'}</td>
                    <td>${inYandexAnalytics ? '<span class="badge badge-success">‚úÖ –î–∞</span>' : '<span class="badge badge-warning">‚ùå –ù–µ—Ç</span>'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('leads-table').innerHTML = html;
        }

        let sortField = 'lead_created_at';
        let sortDir = 'desc';

        function sortLeads(field) {
            if (sortField === field) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDir = 'asc';
            }

            allLeads.sort((a, b) => {
                let aVal = a[field] || '';
                let bVal = b[field] || '';

                if (field === 'lead_created_at') {
                    aVal = new Date(aVal).getTime();
                    bVal = new Date(bVal).getTime();
                }

                if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
                return 0;
            });

            filterLeads();
        }

        // Sync functions
        async function syncYandex() {
            const year = document.getElementById('yandex-year').value;
            const month = document.getElementById('yandex-month').value;

            showTestResult('‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç...', 'info');

            const data = await api('/api/sync/yandex-expenses', {
                method: 'POST',
                body: JSON.stringify({ year: parseInt(year), month: parseInt(month) })
            });

            if (data.success) {
                showTestResult(`‚úÖ –Ø–Ω–¥–µ–∫—Å: –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${data.records} –∑–∞–ø–∏—Å–µ–π`, 'success');
            } else {
                showTestResult(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
            }
        }

        async function syncAmo() {
            const year = document.getElementById('amo-year').value;
            const month = document.getElementById('amo-month').value;

            showTestResult('‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è AmoCRM...', 'info');

            const data = await api('/api/sync/crm-leads', {
                method: 'POST',
                body: JSON.stringify({ year: parseInt(year), month: parseInt(month) })
            });

            if (data.success) {
                showTestResult(`‚úÖ AmoCRM: –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${data.records} —Å–¥–µ–ª–æ–∫`, 'success');
            } else {
                showTestResult(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
            }
        }

        async function syncFull() {
            const yearFrom = parseInt(document.getElementById('full-year-from').value);
            const monthFrom = parseInt(document.getElementById('full-month-from').value);

            showTestResult('‚è≥ –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç', 'info');

            const data = await api('/api/sync/full', {
                method: 'POST',
                body: JSON.stringify({ year_from: yearFrom, month_from: monthFrom })
            });

            if (data.success) {
                showTestResult(`‚úÖ –ì–æ—Ç–æ–≤–æ! –Ø–Ω–¥–µ–∫—Å: ${data.yandex_total} –∑–∞–ø–∏—Å–µ–π, AmoCRM: ${data.amo_total} —Å–¥–µ–ª–æ–∫`, 'success');
                loadAnalytics();
            } else {
                showTestResult(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
            }
        }

        async function testYandex() {
            showTestResult('‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç...', 'info');
            const data = await api('/api/yandex/campaigns');

            if (data.success || data.result) {
                const count = data.result?.Campaigns?.length || data.campaigns?.length || 0;
                showTestResult(`‚úÖ –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç: –Ω–∞–π–¥–µ–Ω–æ ${count} –∫–∞–º–ø–∞–Ω–∏–π`, 'success');
            } else {
                showTestResult(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
            }
        }

        async function testAmo() {
            showTestResult('‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AmoCRM...', 'info');
            const data = await api('/api/amocrm/test');

            if (data.success) {
                showTestResult(`‚úÖ AmoCRM: –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –∞–∫–∫–∞—É–Ω—Ç—É "${data.account}"`, 'success');
            } else {
                showTestResult(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
            }
        }

        function showTestResult(message, type) {
            const el = document.getElementById('test-result');
            el.innerHTML = `<div class="alert alert-${type === 'info' ? 'info' : type}">${message}</div>`;
        }

        // Logs
        async function loadLogs() {
            const data = await api('/api/sync/logs');

            if (data.success) {
                renderLogs(data.logs);
            } else {
                document.getElementById('logs-container').innerHTML =
                    `<div class="alert alert-error">–û—à–∏–±–∫–∞: ${data.error}</div>`;
            }
        }

        function renderLogs(logs) {
            if (!logs || logs.length === 0) {
                document.getElementById('logs-container').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">–ù–µ—Ç –ª–æ–≥–æ–≤</div></div>';
                return;
            }

            let html = '';
            logs.forEach(log => {
                html += `<div class="log-entry ${log.status}">
                    <span class="log-time">${formatDate(log.created_at)}</span>
                    <span class="log-type">${log.sync_type}</span>
                    <span class="log-message">
                        ${log.status === 'success' ? '‚úÖ' : log.status === 'error' ? '‚ùå' : '‚è≥'}
                        ${log.status} - ${log.records_count} –∑–∞–ø–∏—Å–µ–π
                        ${log.error_message ? `<br><small style="color: var(--danger)">${log.error_message}</small>` : ''}
                    </span>
                </div>`;
            });

            document.getElementById('logs-container').innerHTML = html;
        }

        // Chats for broadcasts
        async function loadChats() {
            const data = await api('/api/chats');

            if (data.success) {
                renderBroadcastRecipients(data.chats);
            }
        }

        function renderBroadcastRecipients(chats) {
            if (!chats || chats.length === 0) {
                document.getElementById('broadcast-recipients').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">üë•</div><div class="empty-state-text">–ù–µ—Ç —á–∞—Ç–æ–≤</div></div>';
                return;
            }

            let html = '';
            chats.forEach(chat => {
                const isSelected = selectedChats.has(chat.chat_id);
                const initial = (chat.first_name || chat.username || '?')[0].toUpperCase();

                html += `<div class="chat-item ${isSelected ? 'selected' : ''}" onclick="toggleChatSelection('${chat.chat_id}')">
                    <div class="chat-avatar">${initial}</div>
                    <div class="chat-info">
                        <div class="chat-name">${chat.first_name || ''} ${chat.last_name || ''}</div>
                        <div class="chat-preview">@${chat.username || '–±–µ–∑ username'}</div>
                    </div>
                </div>`;
            });

            document.getElementById('broadcast-recipients').innerHTML = html;
            updateSelectedCount();
        }

        function toggleChatSelection(chatId) {
            if (selectedChats.has(chatId)) {
                selectedChats.delete(chatId);
            } else {
                selectedChats.add(chatId);
            }
            loadChats();
        }

        function selectAllChats() {
            document.querySelectorAll('#broadcast-recipients .chat-item').forEach(item => {
                const chatId = item.getAttribute('onclick').match(/'([^']+)'/)[1];
                selectedChats.add(chatId);
            });
            loadChats();
        }

        function deselectAllChats() {
            selectedChats.clear();
            loadChats();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedChats.size;
        }

        async function sendBroadcast() {
            const message = document.getElementById('broadcast-message').value.trim();
            if (!message) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            if (selectedChats.size === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π');
                return;
            }

            if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ ${selectedChats.size} –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º?`)) return;

            const data = await api('/api/broadcast', {
                method: 'POST',
                body: JSON.stringify({
                    chat_ids: Array.from(selectedChats),
                    message: message
                })
            });

            if (data.success) {
                alert(`–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.sent} –∏–∑ ${data.total}`);
                document.getElementById('broadcast-message').value = '';
                selectedChats.clear();
                loadChats();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        }

        // Chats for viewing
        async function loadChatsForView() {
            const data = await api('/api/chats');

            if (data.success) {
                renderChatsList(data.chats);
            }
        }

        function renderChatsList(chats) {
            if (!chats || chats.length === 0) {
                document.getElementById('chats-list').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">üí¨</div><div class="empty-state-text">–ù–µ—Ç —á–∞—Ç–æ–≤</div></div>';
                return;
            }

            let html = '';
            chats.forEach(chat => {
                const initial = (chat.first_name || chat.username || '?')[0].toUpperCase();

                html += `<div class="chat-item" onclick="loadChatHistory('${chat.chat_id}', '${chat.first_name || ''} ${chat.last_name || ''}')">
                    <div class="chat-avatar">${initial}</div>
                    <div class="chat-info">
                        <div class="chat-name">${chat.first_name || ''} ${chat.last_name || ''}</div>
                        <div class="chat-preview">@${chat.username || '–±–µ–∑ username'}</div>
                    </div>
                </div>`;
            });

            document.getElementById('chats-list').innerHTML = html;
        }

        async function loadChatHistory(chatId, name) {
            document.getElementById('chat-header').textContent = name || '–ß–∞—Ç';
            document.getElementById('chat-messages').innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            const data = await api(`/api/chats/${chatId}/messages`);

            if (data.success) {
                renderChatMessages(data.messages);
            } else {
                document.getElementById('chat-messages').innerHTML =
                    `<div class="alert alert-error">${data.error}</div>`;
            }
        }

        function renderChatMessages(messages) {
            if (!messages || messages.length === 0) {
                document.getElementById('chat-messages').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">üí¨</div><div class="empty-state-text">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div></div>';
                return;
            }

            let html = '';
            messages.forEach(msg => {
                const isBot = msg.is_bot;
                html += `<div style="margin-bottom: 12px; ${isBot ? 'text-align: right;' : ''}">
                    <div style="display: inline-block; max-width: 70%; padding: 12px 16px; border-radius: 16px; ${isBot ? 'background: var(--primary); border-bottom-right-radius: 4px;' : 'background: var(--bg-card-hover); border-bottom-left-radius: 4px;'}">
                        <div style="font-size: 14px;">${msg.text || ''}</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${formatDate(msg.created_at)}</div>
                    </div>
                </div>`;
            });

            document.getElementById('chat-messages').innerHTML = html;
        }

        // Export
        function exportAnalytics() {
            // TODO: implement CSV export
            alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadAnalytics();

            // Set current month in selects
            const now = new Date();
            document.querySelectorAll('select[id$="-month"]').forEach(sel => {
                sel.value = now.getMonth() + 1;
            });
        });
    </script>
</body>
</html>
